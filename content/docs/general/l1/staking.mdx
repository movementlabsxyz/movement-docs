---
id: staking
title: Staking and Delegation
description: "Understanding staking states, delegation pools, and reward distribution on M1"
---

This document explains how staking and delegation work on M1, including stake lifecycle states, delegation pools, reward distribution, and the synchronization mechanism.

## Stake States (Lifecycle)

Staked tokens progress through different states during their lifecycle:

```
┌─────────────────────────────────────────────────────────────────────────┐
│                                                                         │
│   add_stake()         epoch ends           unlock()        lockup ends  │
│       │                   │                   │                │        │
│       ▼                   ▼                   ▼                ▼        │
│  ┌──────────┐        ┌──────────┐        ┌──────────────┐   ┌────────┐  │
│  │ pending  │───────▶│  active  │───────▶│   pending    │──▶│inactive│  │
│  │  active  │        │          │        │   inactive   │   │        │  │
│  └──────────┘        └──────────┘        └──────────────┘   └────────┘  │
│                                                                  │      │
│   Waiting to         Earning            Unlocking but           Ready   │
│   join next          rewards            still in lockup        to       │
│   epoch                                 (still earns!)        withdraw  │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### State Descriptions

- **pending_active** — Just deposited; will become active next epoch
- **active** — Earning staking rewards
- **pending_inactive** — Delegator requested unlock; waiting for lockup to expire. Still earns rewards during the lockup duration!
- **inactive** — Lockup expired; can be withdrawn

**Key point:** `pending_inactive` still earns rewards until the lockup period ends.

## Stake Pool vs Delegation Pool

A delegation pool consists of two components:

- **The staking pool** is used to manage rewards for the whole delegated stakes.
- **The Delegation part** is used to distribute rewards between participants. It uses shares that identify the part of the whole pool each participant earns.

That's why rewards are distributed to the staking pool at each epoch and not directly to the delegated shares.

To see most recent delegation results, the entry function `synchronize_delegation_pool(pool_address)` must be called. This function is automatically called during all delegated pool operations like `add_stake`, `unlock`, or `withdraw`.

```
┌─────────────────────────────────────────────────────────────────────┐
│                        DELEGATION POOL                              │
│   Tracks ownership via SHARES (who owns what percentage)            │
│     • Delegator A: 1,000,000 shares (64.5%)                         │
│     • Delegator B: 500,000 shares (32.3%)                           │
│     • Operator: 50,000 shares (3.2%)                                │
│                              │                                      │
│                              │ owns                                 │
│                              ▼                                      │
│   ┌───────────────────────────────────────────────────────────────┐ │
│   │                      STAKE POOL                               │ │
│   │   Holds actual TOKENS and participates in consensus           │ │
│   │     • active: 100,000 TOKEN                                   │ │
│   │     • pending_inactive: 10,000 TOKEN                          │ │
│   └───────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────┘
```

### Stake Pool

The vault holding actual tokens. Earns rewards from consensus. Can only have ONE owner (the delegation pool's resource account).

### Delegation Pool

The ledger tracking multiple participants via shares. Distributes rewards by increasing share price.

### Why Two Layers?

A stake pool supports only one owner. The delegation pool wraps it to allow multiple delegators, tracking each person's ownership via shares.

Think: Stake pool = vault with cash. Delegation pool = ledger of who owns what percentage of that cash.

## Lazy Synchronization and Gap

The delegation_pool uses **LAZY SYNCHRONIZATION** — NO automatic sync at epoch end!

```
┌─────────────┐         ┌─────────────┐         ┌─────────────┐
│   EPOCH N   │         │  EPOCH N+1  │         │  EPOCH N+2  │
│             │         │             │         │             │
│ stake_pool  │         │ stake_pool  │         │ stake_pool  │
│ += rewards  │         │ += rewards  │         │ += rewards  │
└──────┬──────┘         └──────┬──────┘         └──────┬──────┘
       │                       │                       │
       ▼                       ▼                       ▼
┌─────────────┐         ┌─────────────┐         ┌─────────────┐
│ share_pool  │         │ share_pool  │         │ share_pool  │
│   (stale)   │         │   (stale)   │         │  ← SYNCED!  │
│  no update  │         │  no update  │         │  gap → 0    │
└─────────────┘         └─────────────┘         └─────────────┘
                                                       ▲
                                          user calls add_stake()
```

### What Triggers Sync

- ✅ `add_stake()` — User adding stake
- ✅ `unlock()` — User unlocking stake
- ✅ `withdraw()` — User withdrawing
- ✅ `synchronize_delegation_pool()` — Anyone can call (public)
- ❌ Epoch ends — NO automatic sync

### At Epoch End

1. Rewards go to `stake_pool.active` and `stake_pool.pending_inactive`
2. `delegation_pool` share pools are NOT updated (stale)
3. Commission is NOT calculated yet

### The Gap

The difference between `stake_pool` and `share_pool` is the "gap" — unsynchronized rewards waiting to be distributed to delegators (via share price increase) and operator (via commission).

```
   BEFORE SYNC                              AFTER SYNC
┌────────────────┐                       ┌────────────────┐
│  stake_pool    │                       │  stake_pool    │
│    105,000     │ ─┐                    │    105,000     │
└────────────────┘  │                    └────────────────┘
                    │ gap = 5,000                ║
                    │ (unsync'd rewards)         ║ gap ≈ 0
┌────────────────┐  │                    ┌───────╨────────┐
│  share_pool    │ ─┘                    │  share_pool    │
│    100,000     │                       │ 104,500 + comm │
└────────────────┘                       └────────────────┘
                                          (share price ↑)
```

### Implications

- If no one interacts, rewards accumulate indefinitely
- Commission is paid in one lump sum when sync finally happens
- Operator loses compounding on commission if sync is delayed

## Stake Pool Fields

The StakePool has 4 separate coin fields:

| Field | What it contains | Earns rewards |
|-------|------------------|---------------|
| `active` | Stake participating in consensus | ✅ Yes |
| `pending_active` | Added this epoch, active next epoch | ❌ No |
| `pending_inactive` | Unlocked, waiting to be withdrawable | ✅ Yes |
| `inactive` | Ready to withdraw | ❌ No |

**Total stake** = `active` + `pending_active` + `pending_inactive` + `inactive`

## Two Share Pools: Active and Pending Inactive

The delegation_pool maintains TWO separate share pools that earn rewards:

1. **ACTIVE SHARES POOL** (`active_shares`)
   - Tracks: `stake_pool.active` + `stake_pool.pending_active`
   - Gap = `(active + pending_active) - active_shares.total_coins`

2. **PENDING_INACTIVE SHARES POOL** (`inactive_shares` table)
   - Tracks: `stake_pool.pending_inactive` (until lockup expires)
   - Gap = `pending_inactive - pending_inactive_shares.total_coins`
   - One pool per lockup cycle; when lockup ends, `pending_inactive` → `inactive`

### Why Two Pools?

The duplication isn't redundant — it's necessary because:

- **Different lifecycles:** active can receive deposits; pending_inactive cannot
- **Multiple lockup cycles:** each cycle has its own pending_inactive pool
- **Divergent share prices:** slashing could affect one pool but not the other
- **Withdrawal timing:** only pending_inactive becomes withdrawable after lockup

A single pool would require complex per-position tracking (like NFTs).

### When Sync Happens (for each pool)

1. `gap = stake_pool_value - shares_pool.total_coins`
2. `commission = gap × commission_rate`
3. `net = gap - commission` → share price increases
4. `pool_u64::update_total_coins(shares_pool, stake_pool_value - commission)`
5. Operator buys shares with commission

After sync, both gaps should be ~0 (minus rounding).

## Shares vs Tokens in Delegation Pools

When staking to a delegation pool, delegators receive **SHARES** rather than holding tokens directly. Shares represent proportional ownership of the pool's total token balance. When a delegator deposits tokens, the pool mints shares at the current share price (`total_tokens / total_shares`); when withdrawing, shares are redeemed for tokens at the prevailing price.

### Key Definitions

- **SHARES** — Unit of ownership in the pool (delegator share count stays constant)
- **SHARE PRICE** — `total_tokens / total_shares` (increases as rewards accumulate)
- **VALUE** — `shares × share_price` (a delegator's stake worth in TOKEN)

### What Happens to a Delegator After Rewards

```
   BEFORE REWARDS                        AFTER REWARDS
┌──────────────────┐                  ┌──────────────────┐
│ Delegator A      │                  │ Delegator A      │
│  100 shares      │                  │  100 shares      │  (same!)
│  × 1.00 price    │                  │  × 1.05 price    │  (increased!)
│  ─────────────   │                  │  ─────────────   │
│  = 100 TOKEN     │                  │  = 105 TOKEN     │  (+5 TOKEN)
└──────────────────┘                  └──────────────────┘
```

- Delegator share count stays constant (e.g., 100 shares → 100 shares)
- But share PRICE increases (e.g., 1.00 → 1.05 TOKEN/SHARE)
- So delegator VALUE increases (100 × 1.00 = 100 TOKEN → 100 × 1.05 = 105 TOKEN)

### Reward Distribution Process

When the pool earns staking rewards:

1. **Commission deducted** — The operator's commission percentage is calculated from the gross rewards.
2. **Remainder added to pool** — The net rewards (after commission) are added to `total_tokens` while `total_shares` remains constant, causing the share price to increase.
3. **Operator mints new shares** — The operator uses their commission to buy shares at the new (post-appreciation) share price. Both `total_tokens` and `total_shares` increase proportionally, so the share price remains constant after this step.

This ordering ensures the operator cannot benefit from appreciation on rewards they didn't earn. For delegators, share count stays fixed between stake operations, but VALUE (`shares × share price`) grows as net rewards accumulate.

### Benefits

This approach provides:

- O(1) gas cost for reward distribution
- Proportional allocation without per-account calculations
- Reduced rounding errors

**Example:** A delegator with 100 shares will, after 5% gross rewards with 10% commission, still hold 100 shares—now worth approximately 104.5 tokens (reflecting 4.5% net growth).

